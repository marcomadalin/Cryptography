
from hashlib import sha256, sha384
import sympy
from ecpy.curves import Curve, Point

def byteToInt(b):
    return int(b.hex(),16)

#clave publica
Qx = b'\xe8\x50\x2c\xd0\xd2\x4e\xa2\xb1\x92\xaa\xb6\x73\x0f\xcf\xa0\xb4\x57\xe5\xc2\xc0\x7c\xae\x6e\x55\x91\x4a\xa6\x94\x67\xfa\xa5\xf8'
Qy = b'\xb0\x3f\x46\xac\x23\x52\xb4\x48\x3b\x64\x64\xfb\xea\xcd\xe9\xe4\xfb\x8f\x10\xa7\xf4\xe8\x23\xba\x95\x29\x6e\xef\xca\x72\xbb\x83'
f1 = b'\x00\xf5\x19\x07\x22\x6d\x28\xce\xd0\x4d\xd7\xbd\xef\x7b\x72\xbd\xdf\xc9\x7d\xf7\xf4\xc5\x69\xb5\xb3\x62\x5d\x6c\xd9\xf8\x06\xda\xf4'
f2 = b'\x00\xf6\x44\xa0\xa1\x64\xe1\x04\x8a\xa5\xd8\xad\x24\x1e\xe1\x4d\xc5\xd7\xae\xd5\xa3\x47\x8b\x38\xf0\x79\x67\xbe\xbc\x22\x4e\xe2\x49'
#datos de la curva
Gx = b'\x6B\x17\xD1\xF2\xE1\x2C\x42\x47\xF8\xBC\xE6\xE5\x63\xA4\x40\xF2\x77\x03\x7D\x81\x2D\xEB\x33\xA0\xF4\xA1\x39\x45\xD8\x98\xC2\x96'
Gy = b'\x4F\xE3\x42\xE2\xFE\x1A\x7F\x9B\x8E\xE7\xEB\x4A\x7C\x0F\x9E\x16\x2B\xCE\x33\x57\x6B\x31\x5E\xCE\xCB\xB6\x40\x68\x37\xBF\x51\xF5'
n = b'\xFF\xFF\xFF\xFF\x00\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xBC\xE6\xFA\xAD\xA7\x17\x9E\x84\xF3\xB9\xCA\xC2\xFC\x63\x25\x51'

#'TLS 1.3, server CertificateVerify'
aux = b'\x54\x4c\x53\x20\x31\x2e\x33\x2c\x20\x73\x65\x72\x76\x65\x72\x20\x43\x65\x72\x74\x69\x66\x69\x63\x61\x74\x65\x56\x65\x72\x69\x66\x79'
b20 = b'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'
preambulo = b20 + aux + b'\x00'
with open("mensaje.bin","rb") as f:
    data = f.read()
mensaje384 = bytes.fromhex(sha384(data).hexdigest())
m = bytes.fromhex(sha256(preambulo+mensaje384).hexdigest())

ndec = byteToInt(n)
f1dec = byteToInt(f1)
f2dec = byteToInt(f2)
mdec = byteToInt(m)

cv = Curve.get_curve('secp256r1')
G = Point(byteToInt(Gx),byteToInt(Gy),cv)
Q = Point(byteToInt(Qx),byteToInt(Qy),cv)

w1 = mdec*sympy.mod_inverse(f2dec,ndec)
w2 = f1dec*sympy.mod_inverse(f2dec,ndec)

F = w1*G+w2*Q
x0 = F.x
print('Orden primo? ', sympy.isprime(ndec))
print('La clave publica de Wikipedia pertenece a la curva? ', cv.is_on_curve(Q))
print ('Verificacion firma: ',x0 == (f1dec%ndec))
